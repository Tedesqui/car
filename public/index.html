<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Identificador de Carros com IA</title>
    <style>
        body, html { 
            margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: black; color: white; overflow: hidden; 
        }
        video, canvas { 
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: 0; 
        }
        canvas { display: none; }
        #ui-container { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 2; }
        #controls {
            display: flex; gap: 15px; justify-content: center; align-items: center; padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0));
        }
        button { 
            padding: 12px 20px; font-size: 16px; font-weight: bold; background-color: #007bff; color: white; 
            border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; 
            align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); justify-content: center;
        }
        button.whatsapp-link { background-color: #25D366; }
        button:hover:not(:disabled) { filter: brightness(1.1); transform: translateY(-2px); }
        button:disabled { background: #555; cursor: not-allowed; opacity: 0.7; }
        #output-panel { 
            background: rgba(0,0,0,0.9); padding: 15px; max-height: 85vh; overflow-y: auto; 
            box-sizing: border-box; border-top: 1px solid #444; 
        }
        #car-info { 
            background-color: #2a2a2a; padding: 1rem; border-radius: 6px; white-space: pre-wrap; 
            word-wrap: break-word; line-height: 1.6; font-size: 0.9em;
        }
        .status-text { text-align: center; padding: 20px; font-size: 1.1em; font-weight: 500; }
        .actions-container { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
    </style>
</head>
<body>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas> <div id="ui-container">
        </div>

    <script>
        // ... (suas constantes e fun√ß√µes startCamera, toggleZoom, resetUI) ...
        // COLE O CONTE√öDO DO SCRIPT AT√â AQUI

        async function captureAndIdentify() {
            captureBtn.disabled = true;
            
            // --- OTIMIZA√á√ÉO: Redimensionar a imagem antes de enviar ---
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // Define uma largura m√°xima para a imagem, mantendo a propor√ß√£o
            const MAX_WIDTH = 1280;
            const scale = MAX_WIDTH / video.videoWidth;
            tempCanvas.width = MAX_WIDTH;
            tempCanvas.height = video.videoHeight * scale;

            // Desenha a imagem do v√≠deo no canvas tempor√°rio com o novo tamanho
            tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
            
            // Exibe a imagem capturada no canvas principal na tela
            canvas.width = tempCanvas.width;
            canvas.height = tempCanvas.height;
            ctx.drawImage(tempCanvas, 0, 0);

            video.style.display = 'none';
            canvas.style.display = 'block';
            controlsDiv.style.display = 'none';
            outputPanel.innerHTML = `<div class="status-text">üß† Analisando a imagem...</div>`;

            try {
                // Envia a imagem redimensionada e com qualidade um pouco menor
                const imageDataUrl = tempCanvas.toDataURL('image/jpeg', 0.85);
                const apiUrl = "https://car-identification.vercel.app/api/identify-car";

                // ... (o resto da sua fun√ß√£o captureAndIdentify permanece igual) ...

                if (apiUrl.includes("seu-projeto.vercel.app")) {
                    throw new Error("URL da API n√£o foi configurada. Edite o arquivo HTML.");
                }

                const response = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ image: imageDataUrl })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || `Erro na API: ${response.status}`);
                }
                
                const data = await response.json();
                
                outputPanel.innerHTML = `<h2>‚úÖ An√°lise do Ve√≠culo</h2><pre id="car-info">${data.resultado}</pre>`;
                
                const actionsContainer = document.createElement('div');
                actionsContainer.className = 'actions-container';

                if (data.modelo) {
                    const whatsappButton = document.createElement('button');
                    whatsappButton.className = 'whatsapp-link';
                    whatsappButton.innerHTML = `üí¨ Consultar Estoque via WhatsApp`;
                    
                    const mensagem = `Ol√°! Gostaria de saber se voc√™ tem pra vender esse modelo de ve√≠culo. ${data.modelo} dispon√≠vel.`;
                    const whatsappUrl = `https://wa.me/5524998132856?text=${encodeURIComponent(mensagem)}`;
                    
                    whatsappButton.onclick = () => window.open(whatsappUrl, '_blank');
                    actionsContainer.appendChild(whatsappButton);
                }
                
                const retryButton = document.createElement('button');
                retryButton.innerText = 'Identificar Outro Carro';
                retryButton.onclick = resetUI;
                actionsContainer.appendChild(retryButton);

                outputPanel.appendChild(actionsContainer);

            } catch (err) {
                // ... (seu bloco catch permanece igual) ...
                 outputPanel.innerHTML = `<div class="status-text">‚ùå Erro ao analisar:<br><small>${err.message}</small></div>`;
                const retryContainer = document.createElement('div');
                retryContainer.className = 'actions-container';
                const retryButton = document.createElement('button');
                retryButton.innerText = 'Tentar Novamente';
                retryButton.onclick = resetUI;
                retryContainer.appendChild(retryButton);
                outputPanel.appendChild(retryContainer);
            }
        }

        // ... (seus addEventListeners e a chamada startCamera() final) ...
    </script>
</body>
</html>
